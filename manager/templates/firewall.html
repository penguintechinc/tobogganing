[[extend 'layout.html']]

<div class="p-6 space-y-6" x-data="firewallManager()">
    <!-- Header with Actions -->
    <div class="flex justify-between items-center">
        <div>
            <h3 class="text-lg font-medium text-gray-900">ðŸ”¥ Firewall & Access Control</h3>
            <p class="text-sm text-gray-600">Control domain and IP access for users</p>
        </div>
        <div class="flex space-x-3">
            <button 
                @click="showAddRuleModal = true"
                class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors">
                <i class="fas fa-plus mr-2"></i>
                Add Rule
            </button>
            <button 
                @click="showTestModal = true"
                class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-colors">
                <i class="fas fa-vial mr-2"></i>
                Test Access
            </button>
        </div>
    </div>
    
    [[if error:]]
    <div class="bg-red-50 border border-red-200 rounded-lg p-4">
        <div class="flex items-center">
            <i class="fas fa-exclamation-triangle text-red-500 mr-3"></i>
            <p class="text-red-700">[[=error]]</p>
        </div>
    </div>
    [[pass]]
    
    <!-- Statistics Cards -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
        <div class="bg-white p-6 rounded-lg shadow-sm border">
            <div class="flex items-center">
                <div class="p-2 bg-blue-100 rounded-lg">
                    <i class="fas fa-shield-alt text-blue-600"></i>
                </div>
                <div class="ml-4">
                    <p class="text-sm text-gray-600">Total Rules</p>
                    <p class="text-2xl font-bold text-gray-900" x-text="rules.length">[[=len(rules)]]</p>
                </div>
            </div>
        </div>
        
        <div class="bg-white p-6 rounded-lg shadow-sm border">
            <div class="flex items-center">
                <div class="p-2 bg-green-100 rounded-lg">
                    <i class="fas fa-check text-green-600"></i>
                </div>
                <div class="ml-4">
                    <p class="text-sm text-gray-600">Allow Rules</p>
                    <p class="text-2xl font-bold text-gray-900" x-text="rules.filter(r => r.access_type === 'allow').length">
                        [[=len([r for r in rules if r.access_type.value == 'allow'])]]
                    </p>
                </div>
            </div>
        </div>
        
        <div class="bg-white p-6 rounded-lg shadow-sm border">
            <div class="flex items-center">
                <div class="p-2 bg-red-100 rounded-lg">
                    <i class="fas fa-times text-red-600"></i>
                </div>
                <div class="ml-4">
                    <p class="text-sm text-gray-600">Deny Rules</p>
                    <p class="text-2xl font-bold text-gray-900" x-text="rules.filter(r => r.access_type === 'deny').length">
                        [[=len([r for r in rules if r.access_type.value == 'deny'])]]
                    </p>
                </div>
            </div>
        </div>
        
        <div class="bg-white p-6 rounded-lg shadow-sm border">
            <div class="flex items-center">
                <div class="p-2 bg-purple-100 rounded-lg">
                    <i class="fas fa-users text-purple-600"></i>
                </div>
                <div class="ml-4">
                    <p class="text-sm text-gray-600">Protected Users</p>
                    <p class="text-2xl font-bold text-gray-900">
                        [[=len(set(r.user_id for r in rules))]]
                    </p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Rules Table -->
    <div class="bg-white rounded-lg shadow-sm border">
        <div class="p-6 border-b border-gray-200">
            <div class="flex justify-between items-center">
                <h4 class="text-lg font-medium text-gray-900">Access Control Rules</h4>
                <div class="flex items-center space-x-4">
                    <!-- Filter by user -->
                    <select x-model="selectedUser" @change="filterRules()" class="border border-gray-300 rounded-lg px-3 py-2 text-sm">
                        <option value="">All Users</option>
                        [[for user_obj in users:]]
                        <option value="[[=user_obj.id]]">[[=user_obj.username]] ([[=user_obj.role.value]])</option>
                        [[pass]]
                    </select>
                    
                    <!-- Filter by type -->
                    <select x-model="selectedType" @change="filterRules()" class="border border-gray-300 rounded-lg px-3 py-2 text-sm">
                        <option value="">All Types</option>
                        <option value="domain">Domain</option>
                        <option value="ip">IP</option>
                        <option value="ip_range">IP Range</option>
                        <option value="url_pattern">URL Pattern</option>
                    </select>
                </div>
            </div>
        </div>
        
        <div class="overflow-x-auto">
            <table class="w-full">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="text-left p-4 font-medium text-gray-700">User</th>
                        <th class="text-left p-4 font-medium text-gray-700">Type</th>
                        <th class="text-left p-4 font-medium text-gray-700">Action</th>
                        <th class="text-left p-4 font-medium text-gray-700">Pattern</th>
                        <th class="text-left p-4 font-medium text-gray-700">Priority</th>
                        <th class="text-left p-4 font-medium text-gray-700">Description</th>
                        <th class="text-left p-4 font-medium text-gray-700">Created</th>
                        <th class="text-left p-4 font-medium text-gray-700">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <template x-for="rule in filteredRules" :key="rule.id">
                        <tr class="border-t border-gray-200 hover:bg-gray-50">
                            <td class="p-4">
                                <div class="flex items-center">
                                    <div class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center mr-3">
                                        <i class="fas fa-user text-blue-600 text-sm"></i>
                                    </div>
                                    <div>
                                        <p class="font-medium text-gray-900" x-text="getUserName(rule.user_id)"></p>
                                        <p class="text-sm text-gray-500" x-text="getUserRole(rule.user_id)"></p>
                                    </div>
                                </div>
                            </td>
                            <td class="p-4">
                                <span class="inline-flex px-2 py-1 text-xs font-medium rounded-full"
                                      :class="{
                                          'bg-blue-100 text-blue-800': rule.rule_type === 'domain',
                                          'bg-green-100 text-green-800': rule.rule_type === 'ip',
                                          'bg-purple-100 text-purple-800': rule.rule_type === 'ip_range',
                                          'bg-orange-100 text-orange-800': rule.rule_type === 'url_pattern'
                                      }"
                                      x-text="rule.rule_type.replace('_', ' ').toUpperCase()">
                                </span>
                            </td>
                            <td class="p-4">
                                <span class="inline-flex px-2 py-1 text-xs font-medium rounded-full"
                                      :class="{
                                          'bg-green-100 text-green-800': rule.access_type === 'allow',
                                          'bg-red-100 text-red-800': rule.access_type === 'deny'
                                      }">
                                    <i :class="{
                                        'fas fa-check mr-1': rule.access_type === 'allow',
                                        'fas fa-times mr-1': rule.access_type === 'deny'
                                    }"></i>
                                    <span x-text="rule.access_type.toUpperCase()"></span>
                                </span>
                            </td>
                            <td class="p-4">
                                <code class="bg-gray-100 px-2 py-1 rounded text-sm font-mono" x-text="rule.pattern"></code>
                            </td>
                            <td class="p-4">
                                <span class="text-sm font-medium text-gray-900" x-text="rule.priority"></span>
                            </td>
                            <td class="p-4">
                                <span class="text-sm text-gray-600" x-text="rule.description || '-'"></span>
                            </td>
                            <td class="p-4">
                                <span class="text-sm text-gray-500" x-text="formatDate(rule.created_at)"></span>
                            </td>
                            <td class="p-4">
                                <button 
                                    @click="deleteRule(rule.id)"
                                    class="text-red-600 hover:text-red-800 transition-colors"
                                    title="Delete Rule">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                    </template>
                </tbody>
            </table>
            
            <template x-if="filteredRules.length === 0">
                <div class="p-12 text-center">
                    <i class="fas fa-shield-alt text-4xl text-gray-300 mb-4"></i>
                    <p class="text-gray-500 text-lg">No firewall rules configured</p>
                    <p class="text-gray-400 text-sm">Add your first rule to get started</p>
                </div>
            </template>
        </div>
    </div>
    
    <!-- Add Rule Modal -->
    <div x-show="showAddRuleModal" class="fixed inset-0 z-50 overflow-y-auto" x-cloak>
        <div class="flex items-center justify-center min-h-screen px-4">
            <div class="fixed inset-0 bg-black bg-opacity-50" @click="showAddRuleModal = false"></div>
            <div class="bg-white rounded-lg shadow-xl max-w-md w-full z-10">
                <div class="p-6">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-lg font-medium text-gray-900">Add Firewall Rule</h3>
                        <button @click="showAddRuleModal = false" class="text-gray-400 hover:text-gray-600">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    
                    <form @submit.prevent="addRule()" class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">User</label>
                            <select x-model="newRule.user_id" required class="w-full border border-gray-300 rounded-lg px-3 py-2">
                                <option value="">Select User</option>
                                [[for user_obj in users:]]
                                <option value="[[=user_obj.id]]">[[=user_obj.username]] ([[=user_obj.role.value]])</option>
                                [[pass]]
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Rule Type</label>
                            <select x-model="newRule.rule_type" required class="w-full border border-gray-300 rounded-lg px-3 py-2">
                                <option value="">Select Type</option>
                                <option value="domain">Domain</option>
                                <option value="ip">IP Address</option>
                                <option value="ip_range">IP Range/CIDR</option>
                                <option value="url_pattern">URL Pattern</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Action</label>
                            <select x-model="newRule.access_type" required class="w-full border border-gray-300 rounded-lg px-3 py-2">
                                <option value="">Select Action</option>
                                <option value="allow">Allow</option>
                                <option value="deny">Deny</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Pattern</label>
                            <input 
                                type="text" 
                                x-model="newRule.pattern" 
                                required 
                                class="w-full border border-gray-300 rounded-lg px-3 py-2"
                                :placeholder="getPatternPlaceholder()">
                            <p class="text-xs text-gray-500 mt-1" x-text="getPatternHelp()"></p>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Priority</label>
                            <input 
                                type="number" 
                                x-model="newRule.priority" 
                                min="1" 
                                max="1000" 
                                class="w-full border border-gray-300 rounded-lg px-3 py-2"
                                placeholder="100">
                            <p class="text-xs text-gray-500 mt-1">Lower number = higher priority</p>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Description (Optional)</label>
                            <textarea 
                                x-model="newRule.description" 
                                class="w-full border border-gray-300 rounded-lg px-3 py-2"
                                rows="2"
                                placeholder="Brief description of this rule"></textarea>
                        </div>
                        
                        <div class="flex justify-end space-x-3 pt-4">
                            <button type="button" @click="showAddRuleModal = false" class="px-4 py-2 text-gray-700 border border-gray-300 rounded-lg hover:bg-gray-50">
                                Cancel
                            </button>
                            <button type="submit" :disabled="isSubmitting" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50">
                                <span x-show="!isSubmitting">Add Rule</span>
                                <span x-show="isSubmitting">Adding...</span>
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Test Access Modal -->
    <div x-show="showTestModal" class="fixed inset-0 z-50 overflow-y-auto" x-cloak>
        <div class="flex items-center justify-center min-h-screen px-4">
            <div class="fixed inset-0 bg-black bg-opacity-50" @click="showTestModal = false"></div>
            <div class="bg-white rounded-lg shadow-xl max-w-md w-full z-10">
                <div class="p-6">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-lg font-medium text-gray-900">Test Access</h3>
                        <button @click="showTestModal = false" class="text-gray-400 hover:text-gray-600">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    
                    <form @submit.prevent="testAccess()" class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">User</label>
                            <select x-model="testData.user_id" required class="w-full border border-gray-300 rounded-lg px-3 py-2">
                                <option value="">Select User</option>
                                [[for user_obj in users:]]
                                <option value="[[=user_obj.id]]">[[=user_obj.username]] ([[=user_obj.role.value]])</option>
                                [[pass]]
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Target</label>
                            <input 
                                type="text" 
                                x-model="testData.target" 
                                required 
                                class="w-full border border-gray-300 rounded-lg px-3 py-2"
                                placeholder="example.com, 192.168.1.1, or https://example.com/path">
                            <p class="text-xs text-gray-500 mt-1">Domain, IP address, or URL to test</p>
                        </div>
                        
                        <div x-show="testResult" class="p-4 rounded-lg" :class="testResult && testResult.allowed ? 'bg-green-50 border border-green-200' : 'bg-red-50 border border-red-200'">
                            <div class="flex items-center">
                                <i :class="testResult && testResult.allowed ? 'fas fa-check text-green-600' : 'fas fa-times text-red-600'" class="mr-3"></i>
                                <div>
                                    <p class="font-medium" :class="testResult && testResult.allowed ? 'text-green-800' : 'text-red-800'">
                                        <span x-text="testResult ? testResult.result : ''"></span>
                                    </p>
                                    <p class="text-sm" :class="testResult && testResult.allowed ? 'text-green-600' : 'text-red-600'">
                                        Access <span x-text="testResult && testResult.allowed ? 'granted' : 'denied'"></span> for this target
                                    </p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="flex justify-end space-x-3 pt-4">
                            <button type="button" @click="showTestModal = false" class="px-4 py-2 text-gray-700 border border-gray-300 rounded-lg hover:bg-gray-50">
                                Close
                            </button>
                            <button type="submit" :disabled="isTestingAccess" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 disabled:opacity-50">
                                <span x-show="!isTestingAccess">Test</span>
                                <span x-show="isTestingAccess">Testing...</span>
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Toast Notifications -->
<div id="toast-container" class="fixed top-4 right-4 z-50" x-data="{ toasts: [] }">
    <template x-for="toast in toasts" :key="toast.id">
        <div 
            class="mb-2 p-4 rounded-lg shadow-lg max-w-sm"
            :class="{
                'bg-green-600 text-white': toast.type === 'success',
                'bg-red-600 text-white': toast.type === 'error',
                'bg-blue-600 text-white': toast.type === 'info'
            }"
            x-show="true"
            x-transition:enter="transition ease-out duration-300"
            x-transition:enter-start="opacity-0 transform translate-x-full"
            x-transition:enter-end="opacity-100 transform translate-x-0"
            x-transition:leave="transition ease-in duration-300"
            x-transition:leave-start="opacity-100 transform translate-x-0"
            x-transition:leave-end="opacity-0 transform translate-x-full">
            
            <div class="flex items-center justify-between">
                <div class="flex items-center">
                    <i :class="{
                        'fas fa-check-circle': toast.type === 'success',
                        'fas fa-exclamation-circle': toast.type === 'error',
                        'fas fa-info-circle': toast.type === 'info'
                    }" class="mr-3"></i>
                    <p x-text="toast.message"></p>
                </div>
                <button @click="removeToast(toast.id)" class="ml-4 hover:opacity-75">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>
    </template>
</div>

<script>
function firewallManager() {
    return {
        rules: [[=json.dumps([{
            'id': r.id,
            'user_id': r.user_id,
            'rule_type': r.rule_type.value,
            'access_type': r.access_type.value,
            'pattern': r.pattern,
            'priority': r.priority,
            'description': r.description,
            'created_at': r.created_at.isoformat(),
            'is_active': r.is_active
        } for r in rules])]],
        users: [[=json.dumps([{
            'id': u.id,
            'username': u.username,
            'role': u.role.value
        } for u in users])]],
        filteredRules: [],
        selectedUser: '',
        selectedType: '',
        showAddRuleModal: false,
        showTestModal: false,
        isSubmitting: false,
        isTestingAccess: false,
        newRule: {
            user_id: '',
            rule_type: '',
            access_type: '',
            pattern: '',
            priority: 100,
            description: ''
        },
        testData: {
            user_id: '',
            target: ''
        },
        testResult: null,
        
        init() {
            this.filterRules();
        },
        
        filterRules() {
            this.filteredRules = this.rules.filter(rule => {
                if (this.selectedUser && rule.user_id !== this.selectedUser) return false;
                if (this.selectedType && rule.rule_type !== this.selectedType) return false;
                return true;
            });
        },
        
        getUserName(userId) {
            const user = this.users.find(u => u.id === userId);
            return user ? user.username : 'Unknown';
        },
        
        getUserRole(userId) {
            const user = this.users.find(u => u.id === userId);
            return user ? user.role : '';
        },
        
        getPatternPlaceholder() {
            switch (this.newRule.rule_type) {
                case 'domain': return 'example.com or *.example.com';
                case 'ip': return '192.168.1.1';
                case 'ip_range': return '192.168.1.0/24';
                case 'url_pattern': return 'https://.*\.example\.com/.*';
                default: return 'Enter pattern';
            }
        },
        
        getPatternHelp() {
            switch (this.newRule.rule_type) {
                case 'domain': return 'Use *.domain.com for subdomain matching';
                case 'ip': return 'Exact IP address match';
                case 'ip_range': return 'CIDR notation for IP ranges';
                case 'url_pattern': return 'Regular expression for URL matching';
                default: return 'Select rule type for help';
            }
        },
        
        formatDate(dateString) {
            return new Date(dateString).toLocaleDateString();
        },
        
        async addRule() {
            this.isSubmitting = true;
            try {
                const response = await fetch('/api/web/firewall/rule', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(this.newRule)
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    this.rules.push(data.rule);
                    this.filterRules();
                    this.showToast('Rule added successfully!', 'success');
                    this.showAddRuleModal = false;
                    this.resetNewRule();
                } else {
                    this.showToast(data.error || 'Failed to add rule', 'error');
                }
            } catch (error) {
                this.showToast('Network error', 'error');
            }
            this.isSubmitting = false;
        },
        
        async deleteRule(ruleId) {
            if (!confirm('Are you sure you want to delete this rule?')) return;
            
            try {
                const response = await fetch(`/api/web/firewall/rule/${ruleId}`, {
                    method: 'DELETE'
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    this.rules = this.rules.filter(r => r.id !== ruleId);
                    this.filterRules();
                    this.showToast('Rule deleted successfully!', 'success');
                } else {
                    this.showToast(data.error || 'Failed to delete rule', 'error');
                }
            } catch (error) {
                this.showToast('Network error', 'error');
            }
        },
        
        async testAccess() {
            this.isTestingAccess = true;
            this.testResult = null;
            
            try {
                const response = await fetch('/api/web/firewall/check', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(this.testData)
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    this.testResult = data;
                } else {
                    this.showToast(data.error || 'Failed to test access', 'error');
                }
            } catch (error) {
                this.showToast('Network error', 'error');
            }
            
            this.isTestingAccess = false;
        },
        
        resetNewRule() {
            this.newRule = {
                user_id: '',
                rule_type: '',
                access_type: '',
                pattern: '',
                priority: 100,
                description: ''
            };
        },
        
        showToast(message, type = 'info') {
            const toast = {
                id: Date.now(),
                message: message,
                type: type
            };
            
            const container = document.querySelector('#toast-container');
            if (container) {
                const event = new CustomEvent('show-toast', { detail: toast });
                container.dispatchEvent(event);
            }
        }
    };
}

// Toast management
document.addEventListener('alpine:init', () => {
    Alpine.data('toastManager', () => ({
        toasts: [],
        
        init() {
            this.$el.addEventListener('show-toast', (e) => {
                this.addToast(e.detail);
            });
        },
        
        addToast(toast) {
            this.toasts.push(toast);
            setTimeout(() => {
                this.removeToast(toast.id);
            }, 5000);
        },
        
        removeToast(id) {
            this.toasts = this.toasts.filter(t => t.id !== id);
        }
    }));
});

// Initialize toast container
document.addEventListener('DOMContentLoaded', () => {
    const container = document.querySelector('#toast-container');
    if (container) {
        Alpine.data('toastContainer', () => ({
            toasts: [],
            
            init() {
                this.$el.addEventListener('show-toast', (e) => {
                    this.addToast(e.detail);
                });
            },
            
            addToast(toast) {
                this.toasts.push(toast);
                setTimeout(() => {
                    this.removeToast(toast.id);
                }, 5000);
            },
            
            removeToast(id) {
                this.toasts = this.toasts.filter(t => t.id !== id);
            }
        }));
    }
});
</script>

<style>
[x-cloak] { display: none !important; }
</style>